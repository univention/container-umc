# SPDX-License-Identifier: AGPL-3.0-only
# SPDX-FileCopyrightText: 2023 Univention GmbH

---
{{- /*
Generate a self-signed certificate for the SAML message signing if none is provided.
*/}}
{{- if not (or .Values.umcServer.certPem .Values.umcServer.privateKey) }}
{{- $cert := genSelfSignedCert "saml" nil nil 365 }}
{{- $_ := set .Values.umcServer "certPem" $cert.Cert }}
{{- $_ := set .Values.umcServer "privateKey" $cert.Key }}
{{- end }}

{{ include "common.secret" (dict "top" . "overrides" "umc-server.secret") }}

{{- define "umc-server.secret" }}
{{- with .top }}
data:
  ldap_secret: {{ .Values.umcServer.ldapSecret | b64enc | quote }}
  machine_secret: {{ .Values.umcServer.machineSecret | b64enc | quote }}
  ca_cert: {{ .Values.umcServer.caCert | b64enc | quote }}
  cert_pem: {{ .Values.umcServer.certPem | b64enc | quote }}
  private_key: {{ .Values.umcServer.privateKey | b64enc | quote }}

  db_password: {{ .Values.postgresql.auth.password | b64enc | quote }}
  {{- if .Values.memcached.auth.password }}
  memcached_password: {{ .Values.memcached.auth.password | b64enc | quote }}
  {{- end }}
  {{- if .Values.umcServer.smtpSecret }}
  smtp_password: {{ .Values.umcServer.smtpSecret | b64enc | quote }}
  {{- end }}
{{- end }}
{{- end }}
