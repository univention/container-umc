{{/*
SPDX-FileCopyrightText: 2024-2025 Univention GmbH
SPDX-License-Identifier: AGPL-3.0-only
*/}}
---
kind: "ConfigMap"
apiVersion: "v1"
metadata:
  name: {{ include "common.names.fullname" . }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels:
    {{- include "common.labels.standard" ( dict "customLabels" .Values.additionalLabels "context" . ) | nindent 4 }}
  {{- if .Values.additionalAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.additionalAnnotations "context" . ) | nindent 4 }}
  {{- end }}
data:
  LDAP_SECRET_FILE: "/etc/ldap.secret"
  MACHINE_SECRET_FILE: "/etc/machine.secret"
  PRIVATE_KEY_FILE: {{ .Values.umcServer.privateKeyFile | quote }}
  CA_CERT_FILE: {{ .Values.umcServer.caCertFile | quote }}
  CERT_PEM_FILE: {{ .Values.umcServer.certPemFile | quote }}
  SMTP_SECRET_FILE: /var/secrets/smtp_secret
  UMC_SQL_POOL_SIZE: {{ .Values.postgresql.authSession.config.poolSize | quote }}
  UMC_SQL_MAX_OVERFLOW: {{ .Values.postgresql.authSession.config.maxOverflow | quote }}
  UMC_SQL_POOL_TIMEOUT: {{ .Values.postgresql.authSession.config.poolTimeout | quote }}
  UMC_SQL_POOL_RECYCLE: {{ .Values.postgresql.authSession.config.poolRecycle | quote }}
  UMC_MEMCACHED_SOCKET: {{ printf "%s:%s" (include "umc-server.memcached.host" .) (include "umc-server.memcached.port" .) | quote }}
  {{- if and .Values.memcached .Values.memcached.auth (hasKey .Values.memcached.auth "enabled") }}
    {{- if .Values.memcached.auth.enabled }}
  UMC_MEMCACHED_USERNAME: {{ .Values.memcached.auth.username | default "selfservice" | quote }}
    {{- end }}
  {{- else if and .Values.memcached .Values.memcached.auth .Values.memcached.auth.username }}
    {{- /* Backward compatibility: if auth exists with username but no enabled field, assume enabled */}}
  UMC_MEMCACHED_USERNAME: {{ .Values.memcached.auth.username | quote }}
  {{- end }}

---

kind: "ConfigMap"
apiVersion: "v1"
metadata:
  name: {{ include "common.names.fullname" . }}-pw-reset-email-body
  namespace: {{ include "common.names.namespace" . | quote }}
  labels:
    {{- include "common.labels.standard" . | nindent 4 }}
    {{- if .Values.additionalLabels }}
    {{- include "common.tplvalues.render" ( dict "value" .Values.additionalLabels "context" . ) | nindent 4 }}
    {{- end }}
  {{- if .Values.additionalAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.additionalAnnotations "context" . ) | nindent 4 }}
  {{- end }}
data:
  passwordreset_email_body.txt: |-
{{ .Values.selfService.passwordresetEmailBody | indent 4 }}

...
