# SPDX-License-Identifier: AGPL-3.0-only
# SPDX-FileCopyrightText: 2024-2025 Univention GmbH

---
# Default values for univention-management-console-server
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

## Global values
affinity: {}
environment: {}
fullnameOverride: ""
mountUcr: true
nameOverride: ""
nodeSelector: {}
podAnnotations: {}
replicaCount: 1
tolerations: []

# -- Additional custom labels to add to all deployed objects.
additionalLabels: {}

global:
  # -- Indicates wether this chart is part of a Nubus deployment.
  nubusDeployment: false
  # -- Container registry address.
  imageRegistry: "artifacts.software-univention.de"
  # -- ConfigMap name to read UCR values from.
  configMapUcr: null

  # -- Allow specifying custom images.
  # Ref: https://github.com/bitnami/charts/issues/30850
  security:
    allowInsecureImages: true

  # -- Allows to configure extensions globally.
  extensions: []
  # -- Allows to configure system extensions globally.
  systemExtensions: []

  # -- Credentials to fetch images from private registry.
  # Ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/
  #
  # imagePullSecrets:
  #   - "docker-registry"
  imagePullSecrets: []
  imagePullPolicy: ""
    # -- Configuration for the PostgreSQL database
  postgresql:
    connection:
      host: ""
      port: 5432

# -- Extensions to load. This will override the configuration in
# `global.extensions`.
extensions: []

# -- Allows to configure the system extensions to load. This is intended for
# internal usage, prefer to use `extensions` for user configured extensions.
# This value will override the configuration in `global.systemExtensions`.
systemExtensions: []

# Security Context.
# Ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/
containerSecurityContext:
  privileged: false
  # -- Enable security context.
  enabled: true
  # -- Enable container privileged escalation.
  allowPrivilegeEscalation: false
  # -- Security capabilities for container.
  capabilities:
    drop: ["ALL"]
  # -- Process user id.
  runAsUser: 999
  # -- Process group id.
  runAsGroup: 999
  # Set Seccomp profile.
  seccompProfile:
    # -- Disallow custom Seccomp profile by setting it to RuntimeDefault.
    type: "RuntimeDefault"
  # -- Mounts the container's root filesystem as read-only.
  readOnlyRootFilesystem: true
  # -- Run container as a user.
  runAsNonRoot: true

# Security Context.
# Ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/
containerSecurityContextInit:
  privileged: false
  # -- Enable security context.
  enabled: true
  # -- Enable container privileged escalation.
  allowPrivilegeEscalation: false
  # -- Security capabilities for container.
  capabilities:
    drop:
      - "ALL"
    add:
      - "DAC_OVERRIDE"
      - "SETGID"
      - "SETUID"
      - "SYS_ADMIN"
      - "NET_ADMIN"
      - "AUDIT_CONTROL"
      - "CHOWN"
      - "FOWNER"
  # -- Process user id.
  runAsUser: 999
  # -- Process group id.
  runAsGroup: 999
  # Set Seccomp profile.
  seccompProfile:
    # -- Disallow custom Seccomp profile by setting it to RuntimeDefault.
    type: "RuntimeDefault"
  # -- Mounts the container's root filesystem as read-only.
  readOnlyRootFilesystem: true
  # -- Run container as a user.
  runAsNonRoot: true

# Security Context.
# Ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/
containerSecurityContextSssd:
  privileged: false
  # -- Enable security context.
  enabled: true
  # -- Enable container privileged escalation.
  allowPrivilegeEscalation: false
  # -- Security capabilities for container.
  capabilities:
    drop:
      - "ALL"
    add:
      - "DAC_OVERRIDE"
      - "SETGID"
      - "AUDIT_WRITE"
      - "SETUID"
      - "CHOWN"
      - "SETPCAP"
      - "FOWNER"
      - "FSETID"
      - "KILL"
      - "MKNOD"
      - "NET_RAW"
      - "NET_BIND_SERVICE"
      - "SYS_CHROOT"
  # -- Process user id.
  runAsUser: 999
  # -- Process group id.
  runAsGroup: 999
  # Set Seccomp profile.
  seccompProfile:
    # -- Disallow custom Seccomp profile by setting it to RuntimeDefault.
    type: "RuntimeDefault"
  # -- Mounts the container's root filesystem as read-only.
  readOnlyRootFilesystem: true
  # -- Run container as a user.
  runAsNonRoot: true

# Pod Security Context.
# Ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/
podSecurityContext:
  # -- Enable security context.
  enabled: true
  # -- If specified, all processes of the container are also part of the supplementary group.
  fsGroup: 999
  # -- Change ownership and permission of the volume before being exposed inside a Pod.
  fsGroupChangePolicy: "Always"

# Service account to use.
# Ref.: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/
serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""
  ## @param serviceAccount.automountServiceAccountToken Allows auto mount of ServiceAccountToken on the serviceAccount created
  ## Can be set to false if pods using this serviceAccount do not need to use K8s API
  ##
  automountServiceAccountToken: false
  # -- Additional custom labels for the ServiceAccount.
  labels: {}

# -- Optionally specify a secret to create (primarily intended to be used in development environments to provide custom certificates)
extraSecrets: []

# -- Application configuration of the Univention Management Console Server
umcServer:
  # -- Additional CA Certificate to trust.
  # The value is optional.
  caCert: ""
  # -- Path to file with the CA certificate.
  caCertFile: "/var/secrets/ca_cert"
  # -- Certificate used in the context of SAML to verify metadata signatures.
  # A self-signed certificate will be generated together with the
  # private key if none is provided.
  certPem: null
  # -- The private key related to "certPem" used to sign messages in the context
  # of SAML.
  privateKey: null
  # -- Path to file with the certificate (.pem).
  certPemFile: "/var/secrets/cert_pem"
  # -- Path to file with the certificate's private key (.key).
  privateKeyFile: "/var/secrets/private_key"
  # -- OIDC client for the UMC OAuth 2.0 client
  oidcClient:
    # -- OIDC client secret for the UMC OAuth 2.0 client
    auth:
      password: null
      existingSecret:
        name: null
        keyMapping:
          password: null

## -- Self-service configuration
selfService:
  # -- Content of the email sent for new user sign-ups and password reset requests.
  # The text can contain the following strings which will be substituted accordingly:
  # * {username}: The user wishing to reset his/her password.
  # * {token}: The token to be sent.
  # * {link}: Link to the “Password Reset” website.
  # * {tokenlink}: Link to the “Password Reset” website with the user name and token already entered.
  passwordresetEmailBody: |
    Dear user {username},

    we have received a password reset request for your account. If you did not
    wish to change your password, you can safely ignore this message.

    To change your password please follow this link:

    {tokenlink}

    If the link does not work, you can go to

    {link}

    and enter the following token manually:

    {token}

    Greetings from your password self service system.

# -- Configuration for SSSD.
sssd:
  # -- SSSD log level, from 0 to 10.
  debugLevel: 2

# -- Configuration for the loadBalancer with session stickiness.
proxy:
  replicaCount: 1
  image:
    registry: null
    repository: "library/traefik"
    tag: "3.0@sha256:a208c74fd80a566d4ea376053bff73d31616d7af3f1465a7747b8b89ee34d97e"
    pullPolicy: null

  logLevel: "INFO"

  ## Kubernetes Service for the loadBalancer
  service:
    enabled: true
    type: "ClusterIP"
    ports:
      http:
        containerPort: 8080
        port: 80
        protocol: "TCP"

  updateStrategy:
    type: "RollingUpdate"

## Kubernetes ingress
ingress:
  # -- Enable creation of Ingress.
  enabled: true

  # -- Define the Fully Qualified Domain Name (FQDN) where application should be reachable.
  host: ""

  # Request certificates via cert-manager.io annotation
  certManager:
    # -- Enable cert-manager.io annotaion.
    enabled: true

    # Issuer reference.
    issuerRef:
      # -- Name of cert-manager.io Issuer resource.
      name: ""
      # -- Type of Issuer, f.e. "Issuer" or "ClusterIssuer".
      kind: "ClusterIssuer"

  # -- The Ingress controller class name.
  ingressClassName: ""

  # -- Define ingress annotations.
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/affinity: "none"
    nginx.ingress.kubernetes.io/rewrite-target: "/$2$3"

  # -- Define the Ingress paths.
  paths:
    # - pathType: Prefix
    #   path: /univention/auth
    # - pathType: Prefix
    #   path: /univention/oidc
    # - pathType: Prefix
    #   path: /univention/get
    # - pathType: Prefix
    #   path: /univention/set
    # - pathType: Prefix
    #   path: /univention/command
    # - pathType: Prefix
    #   path: /univention/upload
    # - pathType: Prefix
    #   path: /univention/logout
      - path: /(univention)/(auth|logout|oidc|get|set|command|upload)(.*)$
        pathType: ImplementationSpecific

  # -- Secure an Ingress by specifying a Secret that contains a TLS private key and certificate.
  #
  # Ref.: https://kubernetes.io/docs/concepts/services-networking/ingress/#tls
  tls:
    # -- Enable TLS/SSL/HTTPS for Ingress.
    enabled: true

    # -- The name of the kubernetes secret which contains a TLS private key and certificate.
    # Hint: This secret is not created by this chart and must be provided.
    secretName: ""

# -- Credentials to fetch images from private registry.
# Ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/
#
# imagePullSecrets:
#   - "docker-registry"
imagePullSecrets: []

## Docker image
image:
  registry: ""
  repository: "nubus-dev/images/umc-server"
  pullPolicy: null
  tag: "latest"
  ## Define image sha256 as an alternative to `tag`
  # sha256:

## Container deployment probes
probes:
  liveness:
    enabled: true
    initialDelaySeconds: 10
    timeoutSeconds: 3
    periodSeconds: 30
    failureThreshold: 3
    successThreshold: 1
    tcpSocket:
      port: http
  readiness:
    enabled: true
    initialDelaySeconds: 10
    timeoutSeconds: 3
    periodSeconds: 30
    failureThreshold: 3
    successThreshold: 1
    tcpSocket:
      port: http

sssdProbes:
  liveness:
    # -- Number of failed executions until container is terminated.
    failureThreshold: 10
    # -- Delay after container start until LivenessProbe is executed.
    initialDelaySeconds: 15
    # -- Time between probe executions.
    periodSeconds: 20
    # -- Number of successful executions after failed ones until container is marked healthy.
    successThreshold: 1
    # -- Timeout for command return.
    timeoutSeconds: 5
    exec:
      command:
        - sh
        - -c
        - |
          exit 0
  readiness:
    # -- Number of failed executions until container is terminated.
    failureThreshold: 10
    # -- Delay after container start until LivenessProbe is executed.
    initialDelaySeconds: 15
    # -- Time between probe executions.
    periodSeconds: 20
    # -- Number of successful executions after failed ones until container is marked healthy.
    successThreshold: 1
    # -- Timeout for command return.
    timeoutSeconds: 5
    exec:
      command:
        - sh
        - -c
        - |
          exit 0


## Deployment resources
resources:
  requests:
    memory: "512Mi"
    cpu: "250m"
  limits:
    memory: "4Gi"
    cpu: "4"

## Kubernetes Service for the loadBalancer
service:
  enabled: true
  type: "ClusterIP"
  clusterIP: "None"
  ports:
    http:
      containerPort: 8090
      port: 8090
      protocol: "TCP"

autoscaling:
  enabled: false

# -- Memcached settings.
memcached:
  # -- Set to `true` if you want Memcached to be installed as well.
  #
  # When setting this to `false` be sure to also adjust `memcached.auth.password` below,
  # and the connection settings in the stack-data chart:
  # `stackDataContext.umcMemcachedHostname` and `stackDataContext.umcMemcachedUsername`
  bundled: true
  replicaCount: 1
  # -- Connection parameters. These are required if an external service should be used (bundled is set to `false`).
  connection:
    # -- Memcached host.
    host: ""
    # -- Memcached port.
    port: ""
  auth:
    # -- Enable authentication for memcached. This parameter is only used by the bundled memcached.
    enabled: true
    # -- Memcached username. This parameter is only used by the bundled memcached.
    username: "selfservice"
    # -- Memcached password.
    password: null
    # -- Memcached existing password secret. This parameter is only used by the bundled memcached.
    # -- Memcached password secret reference.
    existingSecret:
      name: null
      keyMapping:
        password: null
  # -- Docker image configuration for memcached. This parameter is only used by the bundled memcached.
  image:
    # -- Memcached image registry.
    registry: null
    # -- Memcached image repository.
    repository: "nubus/images/memcached"
    # -- Memcached image tag.
    tag: "0.1.1@sha256:bac2e34342f07b24bb8f8bb3ed33b1885e18df1998dfff41059fb09ad8c0a96b"
    # -- Memcached image pull policy.
    pullPolicy: null
  # -- Container port for memcached. This parameter is only used by the bundled memcached.
  containerPort: 11211
  # -- Defaults from /ucs/management/univention-self-service/conffiles/etc/memcached_univention-self-service.conf
  #
  # These parameters are only used by the bundled memcached.
  extraEnvVars:
    - name: "MEMCACHED_CACHE_SIZE"
      value: "64"
    - name: "MEMCACHED_EXTRA_FLAGS"
      value: "--disable-evictions"
  # -- Container security context for memcached. This parameter is only used by the bundled memcached.
  containerSecurityContext:
    # -- Enable security context.
    enabled: true
    # -- Process user id.
    runAsUser: 1001
    # -- Process group id.
    runAsGroup: 1001
    # -- Run container as a user.
    runAsNonRoot: true
    privileged: false
    # -- Mounts the container's root filesystem as read-only.
    readOnlyRootFilesystem: true
    # -- Enable container privileged escalation.
    allowPrivilegeEscalation: false
    # -- Security capabilities for container.
    capabilities:
      drop: ["ALL"]
    # Set Seccomp profile.
    seccompProfile:
      # -- Disallow custom Seccomp profile by setting it to RuntimeDefault.
      type: "RuntimeDefault"
  # -- Pod security context for memcached. This parameter is only used by the bundled memcached.
  podSecurityContext:
    # -- Enable security context.
    enabled: true
    # -- If specified, all processes of the container are also part of the supplementary group.
    fsGroup: 1001
    # -- Change ownership and permission of the volume before being exposed inside a Pod.
    fsGroupChangePolicy: "Always"

  # -- Resource requests and limits for memcached. This parameter is only used by the bundled memcached.
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "200m"

  # -- Affinity for memcached pod assignment. This parameter is only used by the bundled memcached.
  affinity: {}
  # -- Node selector for memcached pod assignment. This parameter is only used by the bundled memcached.
  nodeSelector: {}
  # -- Tolerations for memcached pod assignment. This parameter is only used by the bundled memcached.
  tolerations: []
  # -- Pod annotations for memcached. This parameter is only used by the bundled memcached.
  podAnnotations: {}
  # -- Pod labels for memcached. This parameter is only used by the bundled memcached.
  podLabels: {}
  # -- Update strategy for memcached deployment. This parameter is only used by the bundled memcached.
  updateStrategy:
    type: RollingUpdate
  # -- Liveness probe configuration for memcached. This parameter is only used by the bundled memcached.
  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6
    successThreshold: 1
    tcpSocket:
      port: memcache
  # -- Readiness probe configuration for memcached. This parameter is only used by the bundled memcached.
  readinessProbe:
    enabled: true
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 6
    successThreshold: 1
    tcpSocket:
      port: memcache
  startupProbe: {}
  # -- Service configuration for memcached. This parameter is only used by the bundled memcached.
  service:
    # -- Service type for memcached.
    type: "ClusterIP"
    # -- Service port for memcached.
    port: 11211
    # -- Service cluster IP for memcached.
    clusterIP: ""
    # -- Service session affinity for memcached.
    sessionAffinity: ""
    # -- Service annotations for memcached.
    annotations: {}

# -- PostgreSQL settings.
postgresql:
  # -- PostgreSQL database for the authentication session store.
  authSession:
    config:
      # -- The number of connections to keep open inside the connection pool.
      poolSize: 5
      # -- The number of connections to allow in connection pool "overflow", that is connections that can be opened above and beyond the poolSize setting.
      maxOverflow: 10
      # -- Number of seconds to wait before giving up on getting a connection from the pool.
      poolTimeout: 30
      # -- This setting causes the pool to recycle connections after the given number of seconds has passed. It defaults to -1, or no timeout. For example, setting to 3600 means connections will be recycled after one hour.
      poolRecycle: -1
    # -- Connection parameters.
    connection:
      # -- PostgreSQL host.
      host: ""
      # -- PostgreSQL port.
      port: ""
    auth:
      # -- PostgreSQL user.
      username: "umcsession"
      # -- PostgreSQL database.
      database: "umcsession"
      # -- PostgreSQL user password.
      password: ""
      # -- PostgreSQL password secret reference.
      existingSecret:
        name: ""
        keyMapping:
          password: null
  selfservice:
    # -- Connection parameters.
    connection:
      # -- PostgreSQL host.
      host: ""
      # -- PostgreSQL port.
      port: ""
    auth:
      # -- PostgreSQL user.
      username: "selfservice"
      # -- PostgreSQL database.
      database: "selfservice"
      # -- PostgreSQL user password.
      password: ""
      # -- PostgreSQL password secret reference.
      existingSecret:
        name: ""
        keyMapping:
          password: null

# -- LDAP client configuration.
#
# The UMC Server only supports configuring the password via this structure.
# Other parameters are discovery via UCR values.
ldap:
  auth:
    password: null
    existingSecret:
      name: null
      keyMapping:
        password: null
  tlsSecret:
    name: ""
    caCertKey: "ca.crt"
    privateKeyKey: "tls.key"
    certificateKey: "tls.crt"

# -- SMTP client configuration
#
# The UMC Server only supports configuring the password via this structure.
# Other parameters are discovery via UCR values.
smtp:
  auth:
    password: null
    existingSecret:
      name: null
      keyMapping:
        password: null

terminationGracePeriodSeconds: ""
extraVolumeMounts: []

# -- Configure the podManagementPolicy. Possible values are `OrderedReady` and `Parallel`
# For large deployments, set this to `Parallel` to enable quicker deployment and scaleup
podManagementPolicy: "OrderedReady"
# Set up update strategy.
#
# Ref: https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy
#
# Example:
# updateStrategy:
#  type: RollingUpdate
#  rollingUpdate:
#    maxSurge: 25%
#    maxUnavailable: 25%
updateStrategy:
  # -- Set to Recreate if you use persistent volume that cannot be mounted by more than one pods to make sure the pods
  # are destroyed first.
  type: "RollingUpdate"
