# TEMPORARY PATCH - REMOVE WHEN MERGED TO UCS 5.2-4
#
# This patch adds configurable root_path support to UMC server.
# It allows UMC to handle path prefixes (e.g., /univention) directly
# instead of relying on nginx ingress rewrites.
#
# UCS MR: https://git.knut.univention.de/univention/dev/ucs/-/merge_requests/1750
# Issue: univention/dev/internal/team-nubus#1551
#
diff --git a/management/univention-management-console/src/univention/management/console/resource.py b/management/univention-management-console/src/univention/management/console/resource.py
index adc99cec7a..283b00c0d0 100644
--- a/management/univention-management-console/src/univention/management/console/resource.py
+++ b/management/univention-management-console/src/univention/management/console/resource.py
@@ -197,7 +197,18 @@ class Resource(RequestHandler):
     def _proxy_uri(self):  # TODO: replace with tornado builtin
         if self.request.headers.get('X-UMC-HTTPS') == 'on':
             self.request.protocol = 'https'
-        self.request.uri = '/univention%s' % (self.request.uri,)
+        # Only prepend /univention if not using root_path
+        root_path = getattr(self.application, 'root_path', '')
+        if not root_path:
+            self.request.uri = '/univention%s' % (self.request.uri,)
+
+    def _path_without_root_prefix(self):
+        """Strip root_path prefix from request path for path matching."""
+        root_path = getattr(self.application, 'root_path', '')
+        path = self.request.path
+        if root_path and path.startswith(root_path):
+            return path[len(root_path):]
+        return path
 
     async def parse_authorization(self):
         credentials = self.request.headers.get('Authorization')
@@ -286,7 +297,7 @@ class Resource(RequestHandler):
             self.request.body = json.dumps(self.request.body_arguments).encode('ASCII')
         elif self.request.headers.get('Content-Type', '').startswith('multipart/form-data'):  # file upload request
             flavor = self.get_argument('flavor', None)
-        elif self.request.path.startswith(('/auth', '/command', '/get')):  # request is not json
+        elif self._path_without_root_prefix().startswith(('/auth', '/command', '/get')):  # request is not json
             args = {name: self.get_query_arguments(name) for name in self.request.query_arguments}
             if self.request.method == 'POST':
                 args.update({name: self.get_body_arguments(name) for name in self.request.body_arguments})
@@ -427,4 +438,9 @@ class Resource(RequestHandler):
         return langs
 
     def reverse_abs_url(self, name, path=None):
-        return '%s://%s/univention%s' % (self.request.protocol, self.request.host, self.reverse_url(name, *(self.path_args if path is None else path)))
+        root_path = getattr(self.application, 'root_path', '')
+        url_path = self.reverse_url(name, *(self.path_args if path is None else path))
+        if root_path:
+            return '%s://%s%s' % (self.request.protocol, self.request.host, url_path)
+        else:
+            return '%s://%s/univention%s' % (self.request.protocol, self.request.host, url_path)
diff --git a/management/univention-management-console/src/univention/management/console/server.py b/management/univention-management-console/src/univention/management/console/server.py
index 34722f938b..bf78658147 100755
--- a/management/univention-management-console/src/univention/management/console/server.py
+++ b/management/univention-management-console/src/univention/management/console/server.py
@@ -54,40 +54,45 @@ class Application(TApplication):
 
     def __init__(self, **settings):
         tornado.locale.load_gettext_translations('/usr/share/locale', 'univention-management-console')
+
+        # Get root_path from environment variable strip trailing slashes
+        root_path = os.environ.get('UMC_ROOT_PATH', '').strip().rstrip('/')
+        self.root_path = root_path
+
         super().__init__([
-            url(r'/', Index, name='index'),
-            (r'/auth/?', Auth),
-            (r'/upload/?', Upload),
-            (r'/(upload)/(.+)', Command),
-            (r'/(command)/(.+)', Command),
-            (r'/get/session-info', SessionInfo),
-            (r'/get/ipaddress', GetIPAddress),
-            (r'/get/ucr', UCR),
-            (r'/get/meta', Meta),
-            (r'/get/info', Info),
-            (r'/get/newsession', NewSession),
-            (r'/get/modules', Modules),
-            (r'/get/categories', Categories),
-            (r'/get/user/preferences', UserPreferences),
-            (r'/get/hosts', Hosts),
-            (r'/set/?', Set),
-            (r'/set/password', SetPassword),
-            (r'/set/locale', SetLocale),
-            (r'/set/user/preferences', SetUserPreferences),
-            (r'/saml/', SamlACS),
-            (r'/saml/metadata', SamlMetadata),
-            (r'/saml/slo/?', SamlSingleLogout),
-            (r'/saml/logout/?', SamlLogout),
-            (r'/saml/iframe/?', SamlIframeACS),
-            url(r'/oidc/', OIDCLogin, name='oidc-login'),
-            url(r'/oidc/logout', OIDCLogout, name='oidc-logout'),
-            url(r'/oidc/frontchannel-logout', OIDCFrontchannelLogout, name='frontchannel-logout'),
-            url(r'/oidc/backchannel-logout', OIDCBackchannelLogout, name='backchannel-logout'),
-            url(r'/oidc/logout-done', OIDCLogoutFinished, name='oidc-logout-done'),
-            url(r'/oidc/.well-known/oauth-client', OIDCMetadata),
-            url(r'/logout-sse', SSELogoutNotifer),
-            (r'/logout/?', Logout),
-            (r'()/(.+)', Command),
+            url(rf'{root_path}/', Index, name='index'),
+            (rf'{root_path}/auth/?', Auth),
+            (rf'{root_path}/upload/?', Upload),
+            (rf'{root_path}/(upload)/(.+)', Command),
+            (rf'{root_path}/(command)/(.+)', Command),
+            (rf'{root_path}/get/session-info', SessionInfo),
+            (rf'{root_path}/get/ipaddress', GetIPAddress),
+            (rf'{root_path}/get/ucr', UCR),
+            (rf'{root_path}/get/meta', Meta),
+            (rf'{root_path}/get/info', Info),
+            (rf'{root_path}/get/newsession', NewSession),
+            (rf'{root_path}/get/modules', Modules),
+            (rf'{root_path}/get/categories', Categories),
+            (rf'{root_path}/get/user/preferences', UserPreferences),
+            (rf'{root_path}/get/hosts', Hosts),
+            (rf'{root_path}/set/?', Set),
+            (rf'{root_path}/set/password', SetPassword),
+            (rf'{root_path}/set/locale', SetLocale),
+            (rf'{root_path}/set/user/preferences', SetUserPreferences),
+            (rf'{root_path}/saml/', SamlACS),
+            (rf'{root_path}/saml/metadata', SamlMetadata),
+            (rf'{root_path}/saml/slo/?', SamlSingleLogout),
+            (rf'{root_path}/saml/logout/?', SamlLogout),
+            (rf'{root_path}/saml/iframe/?', SamlIframeACS),
+            url(rf'{root_path}/oidc/', OIDCLogin, name='oidc-login'),
+            url(rf'{root_path}/oidc/logout', OIDCLogout, name='oidc-logout'),
+            url(rf'{root_path}/oidc/frontchannel-logout', OIDCFrontchannelLogout, name='frontchannel-logout'),
+            url(rf'{root_path}/oidc/backchannel-logout', OIDCBackchannelLogout, name='backchannel-logout'),
+            url(rf'{root_path}/oidc/logout-done', OIDCLogoutFinished, name='oidc-logout-done'),
+            url(rf'{root_path}/oidc/.well-known/oauth-client', OIDCMetadata),
+            url(rf'{root_path}/logout-sse', SSELogoutNotifer),
+            (rf'{root_path}/logout/?', Logout),
+            (rf'{root_path}()/(.+)', Command),
         ], default_handler_class=Nothing, **settings)
 
         SamlACS.reload()
